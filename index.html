<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Календарь проката инструментов</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;background:#eaf2fb;color:#1f2a37}
    .topbar{background:#1b79d6;color:#fff;padding:18px 16px;text-align:center;font-weight:800;text-transform:uppercase;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .wrap{max-width:1280px;margin:16px auto;padding:0 12px}
    .panel{background:#fff;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(16,24,40,.08);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .search{flex:1 1 320px;min-width:240px}
    .search input{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;outline:none;font-size:15px}
    .btns{display:flex;align-items:center;gap:10px;flex:1 1 auto;justify-content:flex-end;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef2f7;color:#111827;transition:.15s ease}
    .btn:hover{opacity:.92;transform:translateY(-1px)}
    .btn.primary{background:#1b79d6;color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e5e7eb}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:#f8fafc;border:1px solid #e5e7eb;font-weight:700}
    .dot{width:9px;height:9px;border-radius:999px;background:#ef4444;display:inline-block}
    .card{margin-top:14px;background:#fff;border-radius:16px;box-shadow:0 12px 36px rgba(16,24,40,.10);overflow:hidden}
    .gridHead{display:flex;border-bottom:1px solid #e5e7eb;background:#f6f9fe}
    .hTool{flex:0 0 320px;padding:14px 12px;font-weight:900;border-right:1px solid #e5e7eb}
    .hDay{flex:1 0 120px;padding:14px 6px;text-align:center;font-weight:900;border-right:1px solid #e5e7eb}
    .gridBody{max-height:calc(100vh - 220px);overflow:auto}
    .row{display:flex;border-bottom:1px solid #eef2f7}
    .tool{flex:0 0 320px;padding:12px;display:flex;align-items:center;gap:10px;border-right:1px solid #eef2f7;font-weight:800}
    .code{font-size:12px;background:#111827;color:#fff;padding:3px 7px;border-radius:7px}
    .cell{flex:1 0 120px;min-width:120px;height:72px;border-right:1px solid #eef2f7;padding:7px;display:flex;align-items:center;justify-content:center}
    .pill{width:100%;height:100%;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:900;font-size:11px;text-align:center;padding:6px}
    .free{border:2px dashed #cbd5e1;color:#94a3b8;cursor:pointer}
    .free::after{content:"СВОБОДНО"}
    .busy{background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);color:#fff;cursor:pointer}
    
    dialog{border:0;border-radius:14px;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(520px,92vw)}
    .modalTop{padding:14px 14px;background:#111827;color:#fff;font-weight:900}
    .modalBody{padding:14px;background:#fff}
    .modalBtns{padding:12px 14px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #eef2f7}
    .kv{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eef2f7}
    
    /* Скрыть логин по-умолчанию */
    .hidden { display: none !important; }
    .userBox { margin-left: auto; }
  </style>
</head>
<body>

<div class="topbar">АРЕНДА СТРОИТЕЛЬНОГО ИНСТРУМЕНТА</div>

<div class="wrap">
  <div class="panel">
    <div class="search">
      <input id="q" type="text" placeholder="Поиск (код или название)" />
    </div>
    <div class="badge">
      <span class="dot" id="dot"></span>
      <span id="apiStatus">Загрузка...</span>
    </div>
    <div class="btns">
      <button class="btn ghost" id="btnPrev">◀ Назад</button>
      <button class="btn primary" id="periodBtn">...</button>
      <button class="btn ghost" id="btnNext">Вперёд ▶</button>
      
      <!-- ТА САМАЯ КНОПКА-ПЕРЕКЛЮЧАТЕЛЬ -->
      <button class="btn ghost" id="btnListToggle">2️⃣ Все позиции</button>
      <button class="btn primary" id="btnCreateOrder">1️⃣ Создать заказ</button>
      <button class="btn" id="btnReload">Обновить</button>
    </div>
    <div id="userBox" class="userBox"></div>
  </div>

  <div class="card">
    <div class="gridHead" id="gridHead"></div>
    <div class="gridBody" id="gridBody"></div>
    <div style="padding:10px; font-size:12px; color:#666;">Только заказы в статусе «В прокате»</div>
  </div>
</div>

<!-- Модалка для списков -->
<dialog id="dlgList">
  <div class="modalTop" id="dlgListTitle">Список</div>
  <div class="modalBody" id="dlgListBody" style="max-height:60vh; overflow:auto;"></div>
  <div class="modalBtns">
    <button class="btn" onclick="document.getElementById('dlgList').close()">Закрыть</button>
  </div>
</dialog>

<script>
const WORKER_URL = "https://delicate-wood-fa46.yura-ravichev94.workers.dev";
let weekOffset = 0;
let isAllMode = true; // Следим, в каком мы режиме

// Авторизация
const getAuth = () => ({
  hash: sessionStorage.getItem('tg_hash'),
  data: sessionStorage.getItem('tg_data')
});

// Кнопка переключения "Все позиции" / "В прокате"
document.getElementById('btnListToggle').onclick = async function() {
  const auth = getAuth();
  if (!auth.hash) return alert("Войдите через Telegram");
  
  const btn = this;
  const dlg = document.getElementById('dlgList');
  const body = document.getElementById('dlgListBody');
  const title = document.getElementById('dlgListTitle');

  // Определяем куда стучаться
  const endpoint = isAllMode ? "/allpositions" : "/inrent";
  title.textContent = isAllMode ? "Все услуги МойСклад" : "Сейчас в прокате";
  
  try {
    body.innerHTML = "Загрузка...";
    dlg.showModal();
    
    const res = await fetch(`${WORKER_URL}${endpoint}?tg_hash=${auth.hash}&tg_data=${encodeURIComponent(auth.data)}`);
    const data = await res.json();
    
    if (data.positions && data.positions.length > 0) {
      body.innerHTML = data.positions.map(p => `
        <div class="kv">
          <span><b>${p.code || '---'}</b> ${p.name}</span>
          <span style="color:#1b79d6">${p.status || ''}</span>
        </div>
      `).join('');
    } else {
      body.innerHTML = "Пусто";
    }

    // МЕНЯЕМ КНОПКУ ПОСЛЕ УСПЕШНОГО КЛИКА
    if (isAllMode) {
      btn.textContent = "2️⃣ В прокате";
      isAllMode = false;
    } else {
      btn.textContent = "2️⃣ Все позиции";
      isAllMode = true;
    }
    
  } catch (e) {
    body.innerHTML = "Ошибка сети";
  }
};

// Простой рендер календаря и всё остальное (ваши прошлые функции)
async function refresh() {
  const auth = getAuth();
  if(!auth.hash) return renderLogin();
  
  const status = document.getElementById('apiStatus');
  const dot = document.getElementById('dot');
  
  try {
    status.textContent = "Загрузка...";
    const res = await fetch(`${WORKER_URL}?tg_hash=${auth.hash}&tg_data=${encodeURIComponent(auth.data)}`);
    const data = await res.json();
    
    dot.style.background = "#22c55e";
    status.textContent = "API: OK";
    // Тут должен быть ваш код отрисовки сетки (renderGrid)...
  } catch(e) {
    dot.style.background = "#ef4444";
    status.textContent = "Ошибка входа";
  }
}

function renderLogin() {
  document.getElementById('gridBody').innerHTML = `<div style="padding:50px; text-align:center;">Нужна авторизация Telegram</div>`;
}

document.getElementById('btnReload').onclick = () => refresh();
window.onload = refresh;
</script>

</body>
</html>

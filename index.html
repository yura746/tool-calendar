<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tool calendar</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background:#f5f7fb; }
    .topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{ padding:8px 10px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; }
    button{ padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; background:#2563eb; color:#fff; cursor:pointer; }
    button.secondary{ background:#fff; color:#111827; }
    .hint{ color:#6b7280; font-size:13px; }
    .grid{ margin-top:14px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
    .row{ display:flex; padding:10px 12px; border-bottom:1px solid #f0f2f6; }
    .row:last-child{ border-bottom:none; }
    .code{ width:60px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color:#111827; }
    .name{ flex:1; }
    .badge{ display:inline-block; background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; }
    dialog{ border: none; border-radius: 12px; padding: 0; width:min(760px, 96vw); }
    .dlg-head{ padding:12px 14px; background:#111827; color:#fff; display:flex; justify-content:space-between; align-items:center; }
    .dlg-body{ padding: 10px 14px; max-height: 70vh; overflow:auto; background:#fff; }
    .item{ padding:10px 0; border-bottom:1px solid #f0f2f6; display:flex; gap:10px; align-items:flex-start; }
    .item:last-child{ border-bottom:none; }
    .muted{ color:#6b7280; font-size:12px; margin-top:2px; }
    .closebtn{ background:#fff; color:#111827; border:none; border-radius:10px; padding:8px 10px; cursor:pointer; }
    input{ padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; min-width:260px; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="pill">
      <div class="hint">WORKER URL</div>
      <input id="workerUrl" placeholder="https://d5d43h8e7h3vfv2njj28.k1mxzkh0.apigw.yandexcloud.net" />
    </div>

    <button id="btnRefresh">Обновить календарь</button>
    <button id="btnToggleMode" class="secondary">2️⃣ Все позиции</button>
    <div class="pill" id="apiState">API: ?</div>
  </div>

  <div class="hint" style="margin-top:10px;">
    Важно: для кнопок списка используется один и тот же URL, но с параметром
    <b>?mode=allpositions</b> или <b>?mode=inrent</b>.
  </div>

  <div class="grid" id="calendar"></div>

  <dialog id="dlgList">
    <div class="dlg-head">
      <div id="dlgListTitle">Список</div>
      <button class="closebtn" id="dlgClose">Закрыть</button>
    </div>
    <div class="dlg-body" id="dlgListBody"></div>
  </dialog>

<script>
  // === НАСТРОЙКИ ===
  // Можно не задавать тут: вставишь в поле сверху и сохранится в localStorage
  let WORKER_CALENDAR_URL = localStorage.getItem("WORKER_CALENDAR_URL") || "";

  // Telegram auth: твой сайт уже должен уметь подставлять tg_hash и tg_data.
  // Временно берём из URL страницы: ?tg_hash=...&tg_data=...
  function getAuth() {
    const u = new URL(location.href);
    const tg_hash = u.searchParams.get("tg_hash") || "";
    const tg_data = u.searchParams.get("tg_data") || "";
    return { tg_hash, tg_data };
  }

  // === UI refs ===
  const elCalendar = document.getElementById("calendar");
  const elApiState = document.getElementById("apiState");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnToggleMode = document.getElementById("btnToggleMode");
  const inpWorker = document.getElementById("workerUrl");

  const dlgList = document.getElementById("dlgList");
  const dlgListTitle = document.getElementById("dlgListTitle");
  const dlgListBody = document.getElementById("dlgListBody");
  document.getElementById("dlgClose").onclick = () => dlgList.close();

  // init input
  inpWorker.value = WORKER_CALENDAR_URL;
  inpWorker.addEventListener("change", () => {
    WORKER_CALENDAR_URL = inpWorker.value.trim();
    localStorage.setItem("WORKER_CALENDAR_URL", WORKER_CALENDAR_URL);
  });

  function setApiState(text, ok=true) {
    elApiState.textContent = text;
    elApiState.style.color = ok ? "#065f46" : "#991b1b";
    elApiState.style.borderColor = ok ? "#a7f3d0" : "#fecaca";
    elApiState.style.background = ok ? "#ecfdf5" : "#fef2f2";
  }

  function requireWorkerUrl() {
    if (!WORKER_CALENDAR_URL) {
      alert("Вставь WORKER URL сверху");
      throw new Error("WORKER_CALENDAR_URL missing");
    }
  }

  async function apiGet(mode) {
    requireWorkerUrl();
    const { tg_hash, tg_data } = getAuth();
    if (!tg_hash || !tg_data) throw new Error("Нет tg_hash/tg_data в адресной строке страницы");

    const url = `${WORKER_CALENDAR_URL}?mode=${encodeURIComponent(mode)}&tg_hash=${encodeURIComponent(tg_hash)}&tg_data=${encodeURIComponent(tg_data)}`;
    const r = await fetch(url);
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.error || ("HTTP " + r.status));
    if (data.error) throw new Error(data.error);
    return data;
  }

  // === КАЛЕНДАРЬ ===
  async function loadCalendar() {
    try {
      setApiState("API: загрузка...", true);
      const data = await apiGet("calendar"); // вернет {tools:[...]}
      const tools = Array.isArray(data.tools) ? data.tools : [];

      if (tools.length === 0) {
        elCalendar.innerHTML = `<div class="row"><div class="name">Нет данных</div></div>`;
      } else {
        elCalendar.innerHTML = tools.map(t => {
          const b = Array.isArray(t.bookings) ? t.bookings : [];
          const first = b[0];
          return `
            <div class="row">
              <div class="code">${escapeHtml(t.code || "")}</div>
              <div class="name">
                <div><b>${escapeHtml(t.name || "")}</b>
                  ${b.length ? `<span class="badge">В прокате</span>` : ``}
                </div>
                ${first ? `<div class="muted">${escapeHtml(first.date || "")} — ${escapeHtml(first.client || "")} (заказ ${escapeHtml(first.orderName || "")})</div>` : `<div class="muted">свободно</div>`}
              </div>
            </div>
          `;
        }).join("");
      }

      setApiState(`API: OK (${tools.length})`, true);
    } catch (e) {
      setApiState("API: ошибка", false);
      elCalendar.innerHTML = `<div class="row"><div class="name" style="color:#991b1b;">Ошибка: ${escapeHtml(e.message)}</div></div>`;
    }
  }

  // === МОДАЛКА СПИСКА ===
  async function openPositions(mode, title) {
    try {
      dlgListTitle.textContent = title;
      dlgListBody.innerHTML = `<div class="muted">Загрузка...</div>`;
      dlgList.showModal();

      const data = await apiGet(mode); // вернет {positions:[...]}
      const positions = Array.isArray(data.positions) ? data.positions : [];

      if (positions.length === 0) {
        dlgListBody.innerHTML = `<div class="muted">Ничего не найдено</div>`;
        return;
      }

      dlgListBody.innerHTML = positions.map(p => `
        <div class="item">
          <div class="code">${escapeHtml(p.code || "")}</div>
          <div style="flex:1;">
            <div><b>${escapeHtml(p.name || "")}</b></div>
            ${p.client ? `<div class="muted">Клиент: ${escapeHtml(p.client)}${p.orderName ? `, заказ ${escapeHtml(p.orderName)}` : ""}</div>` : ``}
          </div>
        </div>
      `).join("");
    } catch (e) {
      dlgListBody.innerHTML = `<div style="color:#991b1b;">Ошибка: ${escapeHtml(e.message)}</div>`;
    }
  }

  // переключатель кнопки
  let listMode = "allpositions"; // по первому клику покажем все позиции
  btnToggleMode.onclick = async () => {
    if (listMode === "allpositions") {
      await openPositions("allpositions", "Все позиции (услуги)");
      listMode = "inrent";
      btnToggleMode.textContent = "2️⃣ В прокате";
    } else {
      await openPositions("inrent", "Сейчас в прокате");
      listMode = "allpositions";
      btnToggleMode.textContent = "2️⃣ Все позиции";
    }
  };

  btnRefresh.onclick = loadCalendar;

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // авто-загрузка календаря
  loadCalendar();
</script>
</body>
</html>

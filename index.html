const PROXY_URL = "https://moysklad-proxy.–≤–∞—à–µ-–∏–º—è.workers.dev/ms"; // –í–ê–®–ê –°–°–´–õ–ö–ê –ò–ó CLOUDFLARE

async function loadMoySkladData() {
    try {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ú–æ–π–°–∫–ª–∞–¥...");
        
        // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (260 –ø–æ–∑–∏—Ü–∏–π)
        const productsResponse = await fetch(`${PROXY_URL}/entity/product?limit=260`);
        const products = await productsResponse.json();
        
        // 2. –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã (–±—Ä–æ–Ω–∏)
        const ordersResponse = await fetch(`${PROXY_URL}/entity/customerorder?filter=applicable=true`);
        const orders = await ordersResponse.json();

        // 3. –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É (–ª–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è)
        renderCalendarTable(products.rows, orders.rows);
        
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ú–æ–π–°–∫–ª–∞–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cloudflare!");
    }
}

function renderCalendarTable(tools, orders) {
    const tableBody = document.querySelector('.tools-grid');
    tableBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

    tools.forEach(tool => {
        const row = document.createElement('div');
        row.className = 'tool-row';
        
        // –ö–æ–¥ –∏–∑ –ú–æ–π–°–∫–ª–∞–¥ (001-260)
        const toolCode = tool.code || "---"; 
        
        let rowHTML = `
            <div class="tool-name">
                <span class="tool-icon">üõ†</span> ${toolCode} - ${tool.name}
            </div>
        `;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 7 –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        for (let i = 0; i < 7; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];

            // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ –±—Ä–æ–Ω—å –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –∏ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
            const isBooked = orders.some(order => 
                order.positions.rows.some(pos => pos.assortment.id === tool.id) &&
                dateStr >= order.moment.split(' ')[0] // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ –¥–∞—Ç–µ
            );

            rowHTML += `
                <div class="day-cell-grid ${isBooked ? 'busy-1' : 'free'}" 
                     title="${isBooked ? '–ó–∞–Ω—è—Ç–æ' : '–°–≤–æ–±–æ–¥–Ω–æ'}">
                    <span class="status-label">${isBooked ? '–ó–ê–ù–Ø–¢–û' : '–°–í–û–ë–û–î–ù–û'}</span>
                </div>
            `;
        }
        
        row.innerHTML = rowHTML;
        tableBody.appendChild(row);
    });
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadMoySkladData);

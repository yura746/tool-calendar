<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Календарь проката инструментов</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;background:#eaf2fb;color:#1f2a37}
    .topbar{background:#1b79d6;color:#fff;padding:18px 16px;text-align:center;font-weight:800;letter-spacing:.5px;text-transform:uppercase;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .wrap{max-width:1280px;margin:16px auto;padding:0 12px}
    .panel{background:#fff;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(16,24,40,.08);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .search{flex:1 1 320px;min-width:240px}
    .search input{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;outline:none;font-size:15px}
    .btns{display:flex;align-items:center;gap:10px;flex:1 1 auto;justify-content:flex-end;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef2f7;color:#111827;transition:.15s ease}
    .btn:hover{opacity:.92;transform:translateY(-1px)}
    .btn.primary{background:#1b79d6;color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e5e7eb}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:#f8fafc;border:1px solid #e5e7eb;font-weight:700}
    .dot{width:9px;height:9px;border-radius:999px;background:#22c55e;display:inline-block}
    .card{margin-top:14px;background:#fff;border-radius:16px;box-shadow:0 12px 36px rgba(16,24,40,.10);overflow:hidden}
    .gridHead{display:flex;border-bottom:1px solid #e5e7eb;background:#f6f9fe}
    .hTool{flex:0 0 320px;padding:14px 12px;font-weight:900;border-right:1px solid #e5e7eb}
    .hDay{flex:1 0 120px;padding:14px 6px;text-align:center;font-weight:900;border-right:1px solid #e5e7eb}
    .hDay:last-child{border-right:0}
    .gridBody{max-height:calc(100vh - 220px);overflow:auto}
    .row{display:flex;border-bottom:1px solid #eef2f7}
    .row:hover{background:#f7fbff}
    .tool{flex:0 0 320px;padding:12px;display:flex;align-items:center;gap:10px;border-right:1px solid #eef2f7;background:#fbfdff;font-weight:800}
    .code{font-size:12px;background:#111827;color:#fff;padding:3px 7px;border-radius:7px;min-width:44px;text-align:center;letter-spacing:.5px}
    .cell{flex:1 0 120px;min-width:120px;height:72px;border-right:1px solid #eef2f7;padding:7px;display:flex;align-items:center;justify-content:center}
    .cell:last-child{border-right:0}
    .pill{width:100%;height:100%;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-weight:900;font-size:11px;text-align:center;user-select:none;padding:6px;line-height:1.15}
    .free{background:#ffffff;border:2px dashed #cbd5e1;color:#94a3b8}
    .free::after{content:"СВОБОДНО"}
    .busy{background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.18)}
    .small{font-weight:800;opacity:.92;font-size:10px}
    .footerNote{padding:10px 12px;font-size:12px;color:#6b7280;background:#fbfdff;border-top:1px solid #eef2f7}
    dialog{border:0;border-radius:14px;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(520px,92vw)}
    .modalTop{padding:14px 14px;background:#111827;color:#fff;font-weight:900}
    .modalBody{padding:14px;background:#fff}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid #eef2f7}
    .kv:last-child{border-bottom:0}
    .k{color:#6b7280;font-weight:800}
    .v{font-weight:900;color:#111827;text-align:right}
    .modalBtns{padding:12px 14px;display:flex;justify-content:flex-end;gap:10px;background:#fff;border-top:1px solid #eef2f7}
    @media (max-width:820px){
      .hTool,.tool{flex-basis:210px}
      .cell,.hDay{min-width:100px;flex-basis:100px}
      .gridBody{max-height:calc(100vh - 250px)}
    }
  </style>
</head>
<body>
  <div class="topbar">АРЕНДА СТРОИТЕЛЬНОГО ИНСТРУМЕНТА — ПОСУТОЧНО</div>

  <div class="wrap">
    <div class="panel">
      <div class="search">
        <input id="q" type="text" placeholder="Поиск по коду/названию (например: 015 или перфоратор)" />
      </div>

      <div class="badge" title="Источник данных">
        <span class="dot"></span>
        <span id="apiStatus">API: не проверено</span>
      </div>

      <div class="btns">
        <button class="btn ghost" id="btnPrev">◀ Пред. неделя</button>
        <span class="btn primary" id="periodBtn">...</span>
        <button class="btn ghost" id="btnNext">След. неделя ▶</button>
        <button class="btn" id="btnReload">Обновить</button>
      </div>
    </div>

    <div class="card">
      <div class="gridHead" id="gridHead">
        <div class="hTool">ИНСТРУМЕНТ</div>
      </div>
      <div class="gridBody" id="gridBody">
        <div style="padding:26px;text-align:center;color:#6b7280;font-weight:800;">Загрузка…</div>
      </div>
      <div class="footerNote">
        Показываются инструменты, которые сейчас находятся в прокате (заказы со статусом «В прокате»).
      </div>
    </div>
  </div>

  <dialog id="dlg">
    <div class="modalTop">Детали проката</div>
    <div class="modalBody" id="dlgBody"></div>
    <div class="modalBtns">
      <button class="btn" id="dlgClose">Закрыть</button>
    </div>
  </dialog>

<script>
  const WORKER_CALENDAR_URL = "https://your-worker-name.workers.dev"; // <-- замените на ваш URL

  let weekOffset = 0;
  let cacheTools = [];

  const elHead = document.getElementById('gridHead');
  const elBody = document.getElementById('gridBody');
  const elPeriod = document.getElementById('periodBtn');
  const elQ = document.getElementById('q');
  const elApiStatus = document.getElementById('apiStatus');

  const dlg = document.getElementById('dlg');
  const dlgBody = document.getElementById('dlgBody');
  document.getElementById('dlgClose').onclick = () => dlg.close();

  document.getElementById('btnPrev').onclick = () => { weekOffset--; refresh(); };
  document.getElementById('btnNext').onclick = () => { weekOffset++; refresh(); };
  document.getElementById('btnReload').onclick = () => refresh(true);

  function startOfISOWeek(d){
    const x = new Date(d);
    const day = x.getDay() || 7;
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day + 1);
    return x;
  }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function ymd(d){
    const tz = d.getTimezoneOffset()*60000;
    return new Date(d.getTime()-tz).toISOString().slice(0,10);
  }
  function fmtRu(d){ return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'}); }

  function buildWeek(offset){
    const base = startOfISOWeek(new Date());
    const start = addDays(base, offset*7);
    const days = Array.from({length:7}, (_,i)=> addDays(start,i));
    return { start, end: days[6], days };
  }

  function renderHeader(week){
    elHead.innerHTML = `<div class="hTool">ИНСТРУМЕНТ</div>`;
    const names = ['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
    week.days.forEach((d,i)=>{
      const div=document.createElement('div');
      div.className='hDay';
      div.textContent = `${names[i]} ${d.getDate()}`;
      elHead.appendChild(div);
    });
    elPeriod.textContent = `${fmtRu(week.start)} - ${fmtRu(week.end)}`;
  }

  function normalizeTools(tools){
    return (tools||[]).slice().sort((a,b)=>{
      const aa = parseInt((a.code||'0').replace(/\D/g,''),10) || 0;
      const bb = parseInt((b.code||'0').replace(/\D/g,''),10) || 0;
      return aa - bb;
    });
  }

  function applySearch(){
    const q = (elQ.value||'').trim().toLowerCase();
    const rows = elBody.querySelectorAll('.row');
    rows.forEach(r=>{
      if (!q) { r.style.display='flex'; return; }
      r.style.display = r.dataset.search.includes(q) ? 'flex' : 'none';
    });
  }
  elQ.addEventListener('input', applySearch);

  function openDetails(tool, dateStr, booking){
    dlgBody.innerHTML = `
      <div class="kv"><div class="k">Инструмент</div><div class="v">${(tool.code||'---')} ${tool.name||''}</div></div>
      <div class="kv"><div class="k">Дата</div><div class="v">${dateStr}</div></div>
      <div class="kv"><div class="k">Клиент</div><div class="v">${booking.client || 'Клиент'}</div></div>
      <div class="kv"><div class="k">Заказ</div><div class="v">${booking.orderName || ''}</div></div>
      <div class="kv"><div class="k">Статус</div><div class="v" style="color:#1b79d6;font-weight:900;">В ПРОКАТЕ</div></div>
    `;
    dlg.showModal();
  }

  async function fetchToolsFromWorker(){
    const r = await fetch(WORKER_CALENDAR_URL, { cache:"no-store", headers: { "Accept":"application/json" }});
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error(`Worker вернул не JSON: ${text.slice(0,120)}`); }
    if (!r.ok) throw new Error(data && data.error ? data.error : `Worker HTTP ${r.status}`);
    if (!data.tools) return { tools: [] };
    return data;
  }

  function setApiStatus(ok, text){
    const dot = document.querySelector('.dot');
    dot.style.background = ok ? '#22c55e' : '#ef4444';
    elApiStatus.textContent = text || (ok ? 'API: OK' : 'API: ошибка');
  }

  // Отрисовка: одна строка = один инструмент, справа "занят" в день момента заказа.
  // (Это соответствует вашему текущему формату данных от воркера: tools[].bookings[])
  function renderGrid(tools, week){
    const frag = document.createDocumentFragment();

    tools.forEach(tool=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.search = `${tool.code||''} ${tool.name||''}`.toLowerCase();

      const toolDiv = document.createElement('div');
      toolDiv.className = 'tool';
      toolDiv.innerHTML = `<span class="code">${tool.code || '---'}</span><span>${tool.name || ''}</span>`;
      row.appendChild(toolDiv);

      week.days.forEach(d=>{
        const dateStr = ymd(d);
        const booking = (tool.bookings || []).find(b => b.date === dateStr);

        const cell = document.createElement('div');
        cell.className = 'cell';

        const pill = document.createElement('div');

        if (booking){
          pill.className = 'pill busy';
          pill.innerHTML = `В ПРОКАТЕ<div class="small">${(booking.client || 'Клиент').slice(0,18)}</div>`;
          pill.title = `Клиент: ${booking.client || ''}\nЗаказ: ${booking.orderName || ''}`;
          pill.onclick = () => openDetails(tool, dateStr, booking);
        } else {
          pill.className = 'pill free';
        }

        cell.appendChild(pill);
        row.appendChild(cell);
      });

      frag.appendChild(row);
    });

    elBody.innerHTML = '';
    elBody.appendChild(frag);
    applySearch();
  }

  async function refresh(force=false){
    const week = buildWeek(weekOffset);
    renderHeader(week);

    if (!cacheTools.length || force){
      elBody.innerHTML = `<div style="padding:26px;text-align:center;color:#6b7280;font-weight:800;">Загрузка данных из МойСклад…</div>`;
      try{
        const data = await fetchToolsFromWorker();
        cacheTools = normalizeTools(data.tools || []);
        setApiStatus(true, `API: OK (${cacheTools.length} в прокате)`);
      } catch(e){
        console.error(e);
        setApiStatus(false, 'API: ошибка');
        elBody.innerHTML = `<div style="padding:26px;text-align:center;color:#ef4444;font-weight:900;">
          Не удалось загрузить данные из МойСклад.<br>Проверьте WORKER_CALENDAR_URL и статус заказов.
        </div>`;
        return;
      }
    }

    renderGrid(cacheTools, week);
  }

  refresh();
</script>
</body>
</html>

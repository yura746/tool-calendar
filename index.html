<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Календарь проката инструментов</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;background:#eaf2fb;color:#1f2a37}
    .topbar{background:#1b79d6;color:#fff;padding:18px 16px;text-align:center;font-weight:800;letter-spacing:.5px;text-transform:uppercase;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .wrap{max-width:1280px;margin:16px auto;padding:0 12px}
    .panel{background:#fff;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(16,24,40,.08);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .search{flex:1 1 320px;min-width:240px}
    .search input{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;outline:none;font-size:15px}
    .btns{display:flex;align-items:center;gap:10px;flex:1 1 auto;justify-content:flex-end;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef2f7;color:#111827;transition:.15s ease}
    .btn:hover{opacity:.92;transform:translateY(-1px)}
    .btn.primary{background:#1b79d6;color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e5e7eb}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:#f8fafc;border:1px solid #e5e7eb;font-weight:700}
    .dot{width:9px;height:9px;border-radius:999px;background:#ef4444;display:inline-block}
    .card{margin-top:14px;background:#fff;border-radius:16px;box-shadow:0 12px 36px rgba(16,24,40,.10);overflow:hidden}
    .gridHead{display:flex;border-bottom:1px solid #e5e7eb;background:#f6f9fe}
    .hTool{flex:0 0 320px;padding:14px 12px;font-weight:900;border-right:1px solid #e5e7eb}
    .hDay{flex:1 0 120px;padding:14px 6px;text-align:center;font-weight:900;border-right:1px solid #e5e7eb}
    .hDay:last-child{border-right:0}
    .gridBody{max-height:calc(100vh - 220px);overflow:auto}
    .row{display:flex;border-bottom:1px solid #eef2f7}
    .row:hover{background:#f7fbff}
    .tool{flex:0 0 320px;padding:12px;display:flex;align-items:center;gap:10px;border-right:1px solid #eef2f7;background:#fbfdff;font-weight:800}
    .code{font-size:12px;background:#111827;color:#fff;padding:3px 7px;border-radius:7px;min-width:44px;text-align:center;letter-spacing:.5px}
    .cell{flex:1 0 120px;min-width:120px;height:72px;border-right:1px solid #eef2f7;padding:7px;display:flex;align-items:center;justify-content:center}
    .cell:last-child{border-right:0}
    .pill{width:100%;height:100%;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-weight:900;font-size:11px;text-align:center;user-select:none;padding:6px;line-height:1.15}
    .free{background:#ffffff;border:2px dashed #cbd5e1;color:#94a3b8;position:relative;cursor:pointer}
    .free::after{content:"СВОБОДНО"}
    .busy{background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.18);cursor:pointer}
    .small{font-weight:800;opacity:.92;font-size:10px}
    .footerNote{padding:10px 12px;font-size:12px;color:#6b7280;background:#fbfdff;border-top:1px solid #eef2f7}

    dialog{border:0;border-radius:14px;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(520px,92vw)}
    .modalTop{padding:14px 14px;background:#111827;color:#fff;font-weight:900}
    .modalBody{padding:14px;background:#fff}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid #eef2f7}
    .kv:last-child{border-bottom:0}
    .k{color:#6b7280;font-weight:800}
    .v{font-weight:900;color:#111827;text-align:right}
    .modalBtns{padding:12px 14px;display:flex;justify-content:flex-end;gap:10px;background:#fff;border-top:1px solid #eef2f7}

    /* бронирование: кнопка плюс */
    .add-btn{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:28px;height:28px;border-radius:50%;
      background:#1b79d6;color:#fff;display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:900;cursor:pointer;opacity:0;transition:opacity .2s
    }
    .free:hover .add-btn{opacity:1}
    .free .add-btn{pointer-events:none} /* клик ловит pill целиком */

    /* форма */
    .form-group{margin-bottom:14px}
    .form-label{display:block;margin-bottom:6px;font-weight:800;color:#374151}
    .form-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:15px}
    .form-input:focus{outline:none;border-color:#1b79d6;box-shadow:0 0 0 3px rgba(27,121,214,.12)}
    .form-textarea{min-height:80px;resize:vertical}
    .hint{font-size:12px;color:#6b7280;margin-top:6px;line-height:1.35}

    /* экран логина */
    .loginBox{padding:42px 16px;text-align:center}
    .loginTitle{font-weight:900;font-size:20px;margin-bottom:10px}
    .loginText{color:#6b7280;font-weight:700;margin-bottom:18px;line-height:1.35}
    .userPill{display:inline-flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff}
    .userPill .uName{font-weight:900}
    .userPill .uSmall{font-size:12px;color:#6b7280;font-weight:800}
    .logoutBtn{margin-left:8px}

    @media (max-width:820px){
      .hTool,.tool{flex-basis:210px}
      .cell,.hDay{min-width:100px;flex-basis:100px}
      .gridBody{max-height:calc(100vh - 250px)}
    }
  </style>
</head>

<body>
  <div class="topbar">АРЕНДА СТРОИТЕЛЬНОГО ИНСТРУМЕНТА — ПОСУТОЧНО</div>

  <div class="wrap">
    <div class="panel">
      <div class="search">
        <input id="q" type="text" placeholder="Поиск по коду/названию (например: 015 или перфоратор)" />
      </div>

      <div class="badge" title="Источник данных / авторизация">
        <span class="dot" id="dot"></span>
        <span id="apiStatus">Требуется вход</span>
      </div>

      <div class="btns">
        <button class="btn ghost" id="btnPrev">◀ Пред. неделя</button>
        <span class="btn primary" id="periodBtn">...</span>
        <button class="btn ghost" id="btnNext">След. неделя ▶</button>
        
        <!-- Кнопка-переключатель -->
        <button class="btn ghost" id="btnToggleMode">2️⃣ Все позиции</button>
        <button class="btn primary" id="btnCreateOrder">1️⃣ Создать заказ</button>
        
        <button class="btn" id="btnReload">Обновить</button>
      </div>
      <div id="userBox" style="display:none;"></div>
    </div>

    <div class="card">
      <div class="gridHead" id="gridHead">
        <div class="hTool">ИНСТРУМЕНТ</div>
      </div>

      <div class="gridBody" id="gridBody">
        <div style="padding:26px;text-align:center;color:#6b7280;font-weight:800;">Загрузка…</div>
      </div>

      <div class="footerNote">
        Доступ к данным только для менеджеров. Заказы фильтруются по статусу «В прокате».
      </div>
    </div>
  </div>

  <!-- детали -->
  <dialog id="dlgDetails">
    <div class="modalTop">Детали проката</div>
    <div class="modalBody" id="dlgDetailsBody"></div>
    <div class="modalBtns">
      <button class="btn" id="dlgDetailsClose">Закрыть</button>
    </div>
  </dialog>

  <!-- бронирование -->
  <dialog id="dlgBooking">
    <div class="modalTop">Новое бронирование</div>
    <div class="modalBody">
      <form id="bookingForm">
        <div class="form-group">
          <label class="form-label">Инструмент</label>
          <input type="text" id="bookingTool" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Дата</label>
          <input type="text" id="bookingDate" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Клиент (пока текстом)</label>
          <input type="text" id="bookingClient" class="form-input" placeholder="Например: Иванов / ООО Ромашка" required>
          <div class="hint">Позже подключим автопоиск клиентов из МойСклад по телефону/названию.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Комментарий</label>
          <textarea id="bookingComment" class="form-input form-textarea" placeholder="Доп. информация"></textarea>
        </div>
        <div class="modalBtns" style="padding:0;border-top:0;justify-content:flex-end">
          <button type="button" class="btn ghost" id="bookingCancel">Отмена</button>
          <button type="submit" class="btn primary">Забронировать</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Список позиций (все или в прокате) -->
  <dialog id="dlgList">
    <div class="modalTop" id="dlgListTitle">Список позиций</div>
    <div class="modalBody" id="dlgListBody" style="max-height:60vh;overflow:auto;"></div>
    <div class="modalBtns">
      <button class="btn" id="dlgListClose">Закрыть</button>
    </div>
  </dialog>

  <script>
    // ====== НАСТРОЙКИ ======
    const WORKER_CALENDAR_URL = "https://delicate-wood-fa46.yura-ravichev94.workers.dev"; // БЕЗ слеша на конце
    const TELEGRAM_BOT_USERNAME = "prorezerv_bot"; // username бота БЕЗ @

    let weekOffset = 0;
    let cacheTools = [];
    let currentMode = "all"; // "all" или "rent"

    const elHead = document.getElementById('gridHead');
    const elBody = document.getElementById('gridBody');
    const elPeriod = document.getElementById('periodBtn');
    const elQ = document.getElementById('q');
    const elApiStatus = document.getElementById('apiStatus');
    const elDot = document.getElementById('dot');
    const elUserBox = document.getElementById('userBox');

    const dlgDetails = document.getElementById('dlgDetails');
    const dlgDetailsBody = document.getElementById('dlgDetailsBody');
    document.getElementById('dlgDetailsClose').onclick = () => dlgDetails.close();

    const dlgBooking = document.getElementById('dlgBooking');
    const bookingForm = document.getElementById('bookingForm');
    const bookingTool = document.getElementById('bookingTool');
    const bookingDate = document.getElementById('bookingDate');
    const bookingClient = document.getElementById('bookingClient');
    const bookingComment = document.getElementById('bookingComment');
    document.getElementById('bookingCancel').onclick = () => dlgBooking.close();

    const dlgList = document.getElementById('dlgList');
    const dlgListBody = document.getElementById('dlgListBody');
    const dlgListTitle = document.getElementById('dlgListTitle');
    document.getElementById('dlgListClose').onclick = () => dlgList.close();

    document.getElementById('btnPrev').onclick = () => { weekOffset--; refresh(); };
    document.getElementById('btnNext').onclick = () => { weekOffset++; refresh(); };
    document.getElementById('btnReload').onclick = () => refresh(true);

    // ---------- Telegram auth storage ----------
    function getAuth() {
      const tg_hash = sessionStorage.getItem('tg_hash');
      const tg_data = sessionStorage.getItem('tg_data');
      const tg_user = sessionStorage.getItem('tg_user');
      return { tg_hash, tg_data, tg_user };
    }
    function clearAuth() {
      sessionStorage.removeItem('tg_hash');
      sessionStorage.removeItem('tg_data');
      sessionStorage.removeItem('tg_user');
    }

    // Глобальный callback для Telegram Widget
    window.onTelegramAuth = function(user) {
      const dataPairs = [
        ['id', user.id],
        ['first_name', user.first_name || ''],
        ['last_name', user.last_name || ''],
        ['username', user.username || ''],
        ['photo_url', user.photo_url || ''],
        ['auth_date', user.auth_date]
      ];

      const tg_data = dataPairs.map(([k,v]) => `${k}=${encodeURIComponent(String(v))}`).join('&');
      const tg_hash = user.hash;

      sessionStorage.setItem('tg_data', tg_data);
      sessionStorage.setItem('tg_hash', tg_hash);
      sessionStorage.setItem('tg_user', JSON.stringify(user));

      location.reload();
    };

    function setStatus(ok, text) {
      elDot.style.background = ok ? '#22c55e' : '#ef4444';
      elApiStatus.textContent = text;
    }

    function renderUserPill() {
      const { tg_user } = getAuth();
      if (!tg_user) { elUserBox.style.display = 'none'; return; }
      let u; try { u = JSON.parse(tg_user); } catch { return; }

      elUserBox.style.display = 'block';
      elUserBox.innerHTML = `
        <span class="userPill" title="Авторизованный пользователь">
          <span>
            <div class="uName">${escapeHtml(u.first_name || '')}${u.last_name ? ' ' + escapeHtml(u.last_name) : ''}</div>
            <div class="uSmall">${u.username ? '@' + escapeHtml(u.username) : 'id: ' + u.id}</div>
          </span>
          <button class="btn ghost logoutBtn" id="logoutBtn" type="button">Выйти</button>
        </span>
      `;
      document.getElementById('logoutBtn').onclick = () => { clearAuth(); location.reload(); };
    }

    function renderLoginScreen() {
      setStatus(false, 'Требуется вход');
      elBody.innerHTML = `
        <div class="loginBox">
          <div class="loginTitle">Доступ ограничен</div>
          <div class="loginText">Авторизуйтесь через Telegram, чтобы увидеть календарь и клиентов.</div>
          <div id="tg-widget"></div>
        </div>
      `;

      const s = document.createElement('script');
      s.async = true;
      s.src = "https://telegram.org/js/telegram-widget.js?22";
      s.setAttribute('data-telegram-login', "prorezerv_bot");
      s.setAttribute('data-size', 'large');
      s.setAttribute('data-onauth', 'onTelegramAuth(user)');
      s.setAttribute('data-request-access', 'write');
      document.getElementById('tg-widget').appendChild(s);
    }

    // ---------- Обработка новых кнопок ----------
    document.getElementById('btnToggleMode').onclick = async () => {
      const { tg_hash, tg_data } = getAuth();
      if (!tg_hash) return;

      const endpoint = currentMode === "all" ? "allpositions" : "inrent";
      const title = currentMode === "all" ? "Все позиции (услуги)" : "Сейчас в прокате";
      
      dlgListTitle.textContent = title;
      dlgListBody.innerHTML = "Загрузка...";
      dlgList.showModal();

      try {
        const url = `${WORKER_CALENDAR_URL}/${endpoint}?tg_hash=${tg_hash}&tg_data=${encodeURIComponent(tg_data)}`;
        const r = await fetch(url);
        const data = await r.json();

        if (data.positions && data.positions.length > 0) {
          dlgListBody.innerHTML = data.positions.map(p => `
            <div class="kv">
              <div class="k"><b>${escapeHtml(p.code || '---')}</b> ${escapeHtml(p.name)}</div>
              <div class="v" style="color:#1b79d6">${escapeHtml(p.status || '')}</div>
            </div>
          `).join('');
        } else {
          dlgListBody.innerHTML = "Ничего не найдено";
        }

        // Меняем режим и текст кнопки после успешной загрузки
        if (currentMode === "all") {
          currentMode = "rent";
          document.getElementById('btnToggleMode').textContent = "2️⃣ В прокате";
        } else {
          currentMode = "all";
          document.getElementById('btnToggleMode').textContent = "2️⃣ Все позиции";
        }
      } catch (e) {
        dlgListBody.innerHTML = "Ошибка: " + e.message;
      }
    };

    document.getElementById('btnCreateOrder').onclick = () => {
      bookingTool.value = "Новый заказ (общий)";
      bookingDate.value = ymd(new Date());
      dlgBooking.showModal();
    };

    // ---------- Вспомогательные функции даты ----------
    function startOfISOWeek(d){
      const x = new Date(d);
      const day = x.getDay() || 7;
      x.setHours(0,0,0,0);
      x.setDate(x.getDate() - day + 1);
      return x;
    }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function ymd(d){
      const tz = d.getTimezoneOffset()*60000;
      return new Date(d.getTime()-tz).toISOString().slice(0,10);
    }
    function fmtRu(d){ return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'}); }
    
    function buildWeek(offset){
      const base = startOfISOWeek(new Date());
      const start = addDays(base, offset*7);
      const days = Array.from({length:7}, (_,i)=> addDays(start,i));
      return { start, end: days[6], days };
    }

    function renderHeader(week){
      elHead.innerHTML = `<div class="hTool">ИНСТРУМЕНТ</div>`;
      const names = ['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
      week.days.forEach((d,i)=>{
        const div=document.createElement('div');
        div.className='hDay';
        div.textContent = `${names[i]} ${d.getDate()}`;
        elHead.appendChild(div);
      });
      elPeriod.textContent = `${fmtRu(week.start)} - ${fmtRu(week.end)}`;
    }

    function normalizeTools(tools){
      return (tools||[]).slice().sort((a,b)=>{
        const aa = parseInt((a.code||'0').replace(/\D/g,''),10) || 0;
        const bb = parseInt((b.code||'0').replace(/\D/g,''),10) || 0;
        return aa - bb;
      });
    }

    function applySearch(){
      const q = (elQ.value||'').trim().toLowerCase();
      const rows = elBody.querySelectorAll('.row');
      rows.forEach(r=>{
        if (!q) { r.style.display='flex'; return; }
        r.style.display = r.dataset.search.includes(q) ? 'flex' : 'none';
      });
    }
    elQ.addEventListener('input', applySearch);

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
    }

    function openDetails(tool, dateStr, booking){
      dlgDetailsBody.innerHTML = `
        <div class="kv"><div class="k">Инструмент</div><div class="v">${escapeHtml((tool.code||'---') + ' ' + (tool.name||''))}</div></div>
        <div class="kv"><div class="k">Дата</div><div class="v">${escapeHtml(dateStr)}</div></div>
        <div class="kv"><div class="k">Клиент</div><div class="v">${escapeHtml(booking.client || 'Клиент')}</div></div>
        <div class="kv"><div class="k">Заказ</div><div class="v">${escapeHtml(booking.orderName || '')}</div></div>
        <div class="kv"><div class="k">Статус</div><div class="v" style="color:#1b79d6;font-weight:900;">В ПРОКАТЕ</div></div>
      `;
      dlgDetails.showModal();
    }

    function openBookingForm(tool, dateStr){
      bookingTool.value = `${tool.code || '---'} ${tool.name || ''}`;
      bookingDate.value = dateStr;
      bookingClient.value = '';
      bookingComment.value = '';
      dlgBooking.showModal();
      bookingClient.focus();
    }

    bookingForm.addEventListener('submit', (e) => {
      e.preventDefault();
      alert(`Визуально забронировано (без записи в МС):\n${bookingTool.value} на ${bookingDate.value} для ${bookingClient.value}`);
      dlgBooking.close();
    });

    async function fetchToolsFromWorker(){
      const { tg_hash, tg_data } = getAuth();
      if(!tg_hash) throw new Error("Нет авторизации");
      const u = new URL(WORKER_CALENDAR_URL);
      u.searchParams.set('tg_hash', tg_hash);
      u.searchParams.set('tg_data', tg_data);

      const r = await fetch(u.toString(), { cache:"no-store" });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || "Ошибка Worker");
      return data;
    }

    function renderGrid(tools, week){
      const frag = document.createDocumentFragment();
      tools.forEach(tool=>{
        const row = document.createElement('div');
        row.className = 'row';
        row.dataset.search = `${tool.code||''} ${tool.name||''}`.toLowerCase();
        const toolDiv = document.createElement('div');
        toolDiv.className = 'tool';
        toolDiv.innerHTML = `<span class="code">${escapeHtml(tool.code || '---')}</span><span>${escapeHtml(tool.name || '')}</span>`;
        row.appendChild(toolDiv);
        week.days.forEach(d=>{
          const dateStr = ymd(d);
          const booking = (tool.bookings || []).find(b => b.date === dateStr);
          const cell = document.createElement('div');
          cell.className = 'cell';
          const pill = document.createElement('div');
          if (booking){
            pill.className = 'pill busy';
            pill.innerHTML = `В ПРОКАТЕ<div class="small">${escapeHtml((booking.client || 'Клиент').slice(0,18))}</div>`;
            pill.onclick = () => openDetails(tool, dateStr, booking);
          } else {
            pill.className = 'pill free';
            pill.innerHTML = `<div class="add-btn">+</div>`;
            pill.onclick = () => openBookingForm(tool, dateStr);
          }
          cell.appendChild(pill);
          row.appendChild(cell);
        });
        frag.appendChild(row);
      });
      elBody.innerHTML = '';
      elBody.appendChild(frag);
      applySearch();
    }

    async function refresh(force=false){
      const week = buildWeek(weekOffset);
      renderHeader(week);
      if (!cacheTools.length || force){
        elBody.innerHTML = `<div style="padding:26px;text-align:center;color:#6b7280;font-weight:800;">Загрузка данных…</div>`;
        try{
          const data = await fetchToolsFromWorker();
          cacheTools = normalizeTools(data.tools || []);
          setStatus(true, `API: OK (${cacheTools.length} в прокате)`);
        } catch(e){
          setStatus(false, 'API: ошибка');
          elBody.innerHTML = `<div style="padding:26px;text-align:center;color:#ef4444;font-weight:900;">${escapeHtml(e.message)}</div>`;
          return;
        }
      }
      renderGrid(cacheTools, week);
    }

    (function init(){
      renderUserPill();
      const { tg_hash } = getAuth();
      if (!tg_hash) renderLoginScreen();
      else refresh();
    })();
  </script>
</body>
</html>

